<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f0f1e">
  <title>ğŸ± ë¡œë˜ ë¶„ì„ê¸°</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--bg:#0f0f1e;--card:#1a1a2e;--card2:#252542;--primary:#667eea;--primary2:#764ba2;--text:#fff;--text2:#888899;--success:#51cf66;--danger:#ff6b6b;--warning:#ffd43b}
    html,body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);min-height:100vh;color:var(--text)}
    .app{max-width:500px;margin:0 auto;padding:16px;padding-bottom:80px}
    .header{text-align:center;background:linear-gradient(135deg,var(--primary),var(--primary2));margin:-16px -16px 16px;padding:24px 16px}
    .header h1{font-size:1.5rem;margin-bottom:4px}.header p{font-size:12px;opacity:.8}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:6px 0;padding-bottom:max(6px,env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.1);z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 16px;color:var(--text2);font-size:10px;background:none;border:none;cursor:pointer}
    .nav-item.active{color:var(--primary)}.nav-item span{font-size:20px;margin-bottom:2px}
    .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:12px}
    .card-title{font-size:13px;color:var(--text2);margin-bottom:12px}
    .card-highlight{background:linear-gradient(135deg,rgba(102,126,234,.15),rgba(118,75,162,.15));border:1px solid rgba(102,126,234,.3)}
    .balls{display:flex;gap:6px;justify-content:center;align-items:center;flex-wrap:wrap}
    .ball{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;color:#fff}
    .ball.sm{width:32px;height:32px;font-size:12px}.ball.xs{width:26px;height:26px;font-size:10px}
    .ball.b1{background:linear-gradient(135deg,#ffd700,#f0a500)}.ball.b2{background:linear-gradient(135deg,#4dabf7,#228be6)}
    .ball.b3{background:linear-gradient(135deg,#ff6b6b,#e03131)}.ball.b4{background:linear-gradient(135deg,#868e96,#495057)}
    .ball.b5{background:linear-gradient(135deg,#51cf66,#2f9e44)}.ball.bonus{box-shadow:0 0 0 3px var(--bg),0 0 0 5px var(--primary)}
    .plus{color:var(--text2);font-size:18px;margin:0 4px}
    .round-nav{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px}
    .round-nav button{width:44px;height:44px;border-radius:50%;border:none;background:var(--card2);color:var(--text);font-size:18px;cursor:pointer}
    .round-nav button:disabled{opacity:.3}.round-nav button:active:not(:disabled){background:var(--primary)}
    .round-display{text-align:center;cursor:pointer}
    .round-display .round-num{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),var(--primary2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .round-display .round-date{font-size:13px;color:var(--text2)}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center}
    .modal-overlay.active{display:flex}
    .modal{background:var(--card);border-radius:16px;padding:24px;width:90%;max-width:300px}
    .modal h3{margin-bottom:16px;text-align:center}
    .modal input{width:100%;padding:14px;border:none;border-radius:12px;background:var(--card2);color:var(--text);font-size:18px;text-align:center;margin-bottom:12px}
    .modal-buttons{display:flex;gap:8px}.modal-buttons button{flex:1}
    .prize-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:16px}
    .prize-item{background:var(--card2);padding:12px;border-radius:12px}
    .prize-item.main{grid-column:span 2;background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,107,107,.15));border:1px solid rgba(255,215,0,.3);text-align:center}
    .prize-label{font-size:11px;color:var(--text2);margin-bottom:4px}
    .prize-value{font-size:18px;font-weight:700}.prize-value.highlight{color:var(--warning);font-size:24px}
    .prize-sub{font-size:11px;color:var(--text2);margin-top:4px}.prize-detail{font-size:12px;color:var(--success);margin-top:4px}
    .input,.select{width:100%;padding:14px;border:none;border-radius:12px;background:var(--card2);color:var(--text);font-size:16px}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
    .btn:active{transform:scale(.98)}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
    .btn-success{background:linear-gradient(135deg,#51cf66,#2f9e44);color:#fff}
    .btn-outline{background:transparent;border:1px solid var(--primary);color:var(--primary)}.btn-sm{padding:10px 16px;font-size:13px;width:auto}
    .number-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:4px;margin-bottom:12px}
    .number-btn{aspect-ratio:1;border:none;border-radius:8px;font-weight:600;font-size:12px;cursor:pointer}
    .number-btn.b1{background:rgba(255,215,0,.2);color:#ffd700}.number-btn.b2{background:rgba(77,171,247,.2);color:#4dabf7}
    .number-btn.b3{background:rgba(255,107,107,.2);color:#ff6b6b}.number-btn.b4{background:rgba(134,142,150,.2);color:#868e96}
    .number-btn.b5{background:rgba(81,207,102,.2);color:#51cf66}
    .number-btn.selected{background:var(--primary)!important;color:#fff!important}
    .number-btn.excluded{background:var(--danger)!important;color:#fff!important}
    .number-btn.required{background:var(--success)!important;color:#fff!important}
    .check-result{text-align:center;padding:20px;background:var(--card2);border-radius:12px;margin-top:12px}
    .check-rank{font-size:36px;font-weight:800}
    .check-rank.win{background:linear-gradient(135deg,var(--warning),#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .check-rank.lose{color:var(--text2)}.check-prize{font-size:20px;font-weight:700;margin:8px 0}
    .stat-table{width:100%;border-collapse:collapse;font-size:12px}
    .stat-table th,.stat-table td{padding:10px 8px;text-align:center;border-bottom:1px solid var(--card2)}
    .stat-table th{background:var(--card2);color:var(--text2);cursor:pointer;position:sticky;top:0}
    .stat-table th:hover{background:var(--primary);color:#fff}.stat-table tr:hover{background:rgba(102,126,234,.1)}
    .filter-bar{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
    .filter-chip{padding:6px 12px;border-radius:16px;font-size:11px;background:var(--card2);color:var(--text2);border:none;cursor:pointer}
    .filter-chip.active{background:var(--primary);color:#fff}
    .predict-result{background:linear-gradient(135deg,rgba(102,126,234,.1),rgba(118,75,162,.1));border:1px solid rgba(102,126,234,.3);border-radius:12px;padding:12px;margin-bottom:8px}
    .predict-index{font-size:11px;color:var(--primary);margin-bottom:6px}
    .section{display:none}.section.active{display:block}
    .loading{text-align:center;padding:60px 20px}
    .spinner{width:40px;height:40px;border:4px solid var(--card2);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .alert{padding:12px;border-radius:10px;margin-bottom:12px;font-size:13px}.alert-danger{background:rgba(255,107,107,.2);color:var(--danger)}
    .tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto}
    .tab{padding:8px 14px;border-radius:20px;font-size:12px;white-space:nowrap;background:var(--card2);color:var(--text2);border:none;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff}
    .selected-nums{display:flex;align-items:center;gap:8px;margin:12px 0;min-height:36px}
    .selected-nums-label{font-size:12px;color:var(--text2)}
    .clear-btn{padding:6px 12px;border-radius:8px;border:1px solid var(--danger);background:transparent;color:var(--danger);font-size:11px;cursor:pointer}
    .table-scroll{max-height:400px;overflow-y:auto}
  </style>
</head>
<body>
<div class="app">
  <header class="header"><h1>ğŸ± ë¡œë˜ ë¶„ì„ê¸°</h1><p>ë‹¹ì²¨ë²ˆí˜¸ ì¡°íšŒ Â· í†µê³„ ë¶„ì„ Â· AI ì˜ˆì¸¡</p></header>
  <div id="loading" class="loading"><div class="spinner"></div><p>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
  
  <div id="sec-home" class="section">
    <div class="card card-highlight">
      <div class="round-nav">
        <button onclick="prevRound()" id="prevBtn">â—€</button>
        <div class="round-display" onclick="openRoundModal()">
          <div class="round-num" id="currentRound">-</div>
          <div class="round-date" id="currentDate">í„°ì¹˜í•˜ì—¬ íšŒì°¨ ì…ë ¥</div>
        </div>
        <button onclick="nextRound()" id="nextBtn">â–¶</button>
      </div>
      <div class="balls" id="currentBalls"></div>
      <div class="prize-grid">
        <div class="prize-item main">
          <div class="prize-label">ğŸ† 1ë“± ë‹¹ì²¨ê¸ˆ (1ì¸ë‹¹)</div>
          <div class="prize-value highlight" id="prize1">-</div>
          <div class="prize-detail" id="prize1Net">ì‹¤ìˆ˜ë ¹ì•¡: -</div>
          <div class="prize-sub" id="prize1Info">-</div>
        </div>
        <div class="prize-item"><div class="prize-label">2ë“± (1ì¸ë‹¹)</div><div class="prize-value" id="prize2">-</div><div class="prize-sub" id="prize2Info">-</div></div>
        <div class="prize-item"><div class="prize-label">3ë“± (1ì¸ë‹¹)</div><div class="prize-value" id="prize3">-</div><div class="prize-sub" id="prize3Info">-</div></div>
        <div class="prize-item"><div class="prize-label">ì´ íŒë§¤ì•¡</div><div class="prize-value" id="totalSales">-</div></div>
        <div class="prize-item"><div class="prize-label">ì´ ë‹¹ì²¨ì</div><div class="prize-value" id="totalWinners">-</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ« ë‚´ ë²ˆí˜¸ ë‹¹ì²¨ í™•ì¸</div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">ë²ˆí˜¸ 6ê°œ ì„ íƒ (í˜„ì¬ íšŒì°¨ ê¸°ì¤€)</p>
      <div class="number-grid" id="checkGrid"></div>
      <div class="selected-nums"><span class="selected-nums-label">ì„ íƒ:</span><div id="selectedBalls" style="display:flex;gap:4px;flex:1"></div><button class="clear-btn" onclick="clearCheck()">ì´ˆê¸°í™”</button></div>
      <button class="btn btn-success" onclick="checkMyNumbers()">ë‹¹ì²¨ í™•ì¸</button>
      <div id="checkResult"></div>
    </div>
  </div>
  
  <div id="sec-stats" class="section">
    <div class="tabs">
      <button class="tab active" onclick="showStatTab('freq',this)">ì¶œí˜„ë¹ˆë„</button>
      <button class="tab" onclick="showStatTab('pattern',this)">íŒ¨í„´ë¶„ì„</button>
      <button class="tab" onclick="showStatTab('zscore',this)">Z-Score</button>
    </div>
    <div id="stat-freq" class="stat-content">
      <div class="card">
        <div class="card-title">ğŸ“Š ë²ˆí˜¸ë³„ í†µê³„</div>
        <div class="filter-bar">
          <button class="filter-chip active" onclick="filterTable('all',this)">ì „ì²´</button>
          <button class="filter-chip" onclick="filterTable('1-10',this)">1-10</button>
          <button class="filter-chip" onclick="filterTable('11-20',this)">11-20</button>
          <button class="filter-chip" onclick="filterTable('21-30',this)">21-30</button>
          <button class="filter-chip" onclick="filterTable('31-40',this)">31-40</button>
          <button class="filter-chip" onclick="filterTable('41-45',this)">41-45</button>
          <button class="filter-chip" onclick="filterTable('hot',this)">ğŸ”¥HOT</button>
          <button class="filter-chip" onclick="filterTable('cold',this)">â„ï¸COLD</button>
        </div>
        <div class="table-scroll"><table class="stat-table"><thead><tr>
          <th onclick="sortTable('num')">ë²ˆí˜¸</th><th onclick="sortTable('count')">ì¶œí˜„</th>
          <th onclick="sortTable('percent')">ë¹„ìœ¨</th><th onclick="sortTable('last')">ìµœê·¼</th><th onclick="sortTable('avgGap')">í‰ê· ê°„ê²©</th>
        </tr></thead><tbody id="freqTableBody"></tbody></table></div>
      </div>
    </div>
    <div id="stat-pattern" class="stat-content" style="display:none">
      <div class="card"><div class="card-title">âš–ï¸ í™€ì§ ë¶„í¬</div><table class="stat-table"><thead><tr><th>í™€:ì§</th><th>íšŸìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead><tbody id="oddEvenBody"></tbody></table></div>
      <div class="card"><div class="card-title">ğŸ“ ê³ ì € ë¶„í¬</div><table class="stat-table"><thead><tr><th>ì €:ê³ </th><th>íšŸìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead><tbody id="highLowBody"></tbody></table></div>
      <div class="card"><div class="card-title">ğŸ“ˆ ê¸°íƒ€ í†µê³„</div><div id="extraStats" style="font-size:13px;line-height:1.8"></div></div>
    </div>
    <div id="stat-zscore" class="stat-content" style="display:none">
      <div class="card">
        <div class="card-title">ğŸ“ Z-Score ë¶„ì„</div>
        <p style="font-size:11px;color:var(--text2);margin-bottom:12px;">|Z|>1.5: ì£¼ëª©í•  ë²ˆí˜¸</p>
        <div class="filter-bar">
          <button class="filter-chip active" onclick="filterZ('all',this)">ì „ì²´</button>
          <button class="filter-chip" onclick="filterZ('hot',this)">ğŸ”¥Z>1.5</button>
          <button class="filter-chip" onclick="filterZ('cold',this)">â„ï¸Z<-1.5</button>
        </div>
        <div class="table-scroll"><table class="stat-table"><thead><tr>
          <th onclick="sortZ('num')">ë²ˆí˜¸</th><th onclick="sortZ('count')">ì¶œí˜„</th><th onclick="sortZ('zscore')">Z-Score</th><th>ìƒíƒœ</th>
        </tr></thead><tbody id="zscoreBody"></tbody></table></div>
      </div>
    </div>
  </div>
  
  <div id="sec-predict" class="section">
    <div class="card">
      <div class="card-title">âš™ï¸ ì˜ˆì¸¡ ì„¤ì •</div>
      <div style="margin-bottom:16px"><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:8px">ğŸ“Š ì „ëµ</label>
        <select id="predictStrategy" class="input">
          <option value="balanced">ê· í˜• (ë¹ˆë„+ë¯¸ì¶œí˜„)</option><option value="hot">HOT</option><option value="cold">COLD</option>
          <option value="pattern">íŒ¨í„´ (í™€ì§ê· í˜•)</option><option value="zscore">Z-Score</option><option value="trend">íŠ¸ë Œë“œ</option><option value="random">ëœë¤</option>
        </select>
      </div>
      <div style="margin-bottom:16px"><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:8px">ğŸš« ì œì™¸ ë²ˆí˜¸</label><div class="number-grid" id="excludeGrid"></div></div>
      <div style="margin-bottom:16px"><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:8px">â­ í•„ìˆ˜ ë²ˆí˜¸ (ìµœëŒ€5)</label><div class="number-grid" id="requireGrid"></div></div>
      <div style="margin-bottom:16px"><label style="font-size:12px;color:var(--text2);display:block;margin-bottom:8px">ğŸ”¢ ìƒì„± ê°œìˆ˜</label>
        <div style="display:flex;align-items:center;gap:12px"><button class="btn btn-outline btn-sm" onclick="adjustCount(-1)">âˆ’</button><span id="predictCount" style="font-size:20px;font-weight:700;min-width:40px;text-align:center">5</span><button class="btn btn-outline btn-sm" onclick="adjustCount(1)">+</button></div>
      </div>
      <button class="btn btn-primary" onclick="generatePrediction()">âœ¨ ë²ˆí˜¸ ìƒì„±</button>
    </div>
    <div id="predictResults"></div>
  </div>
  
  <div id="sec-settings" class="section">
    <div class="card"><div class="card-title">ğŸ“Š ë°ì´í„° í˜„í™©</div><div id="dataStatus"></div></div>
    <div class="card"><div class="card-title">ğŸ”„ ê´€ë¦¬</div><button class="btn btn-outline" onclick="location.reload()" style="margin-bottom:8px">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button><button class="btn btn-outline" onclick="exportData()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button></div>
    <div class="card"><div class="card-title">â„¹ï¸ ì •ë³´</div><p style="font-size:12px;color:var(--text2);line-height:1.6">âš ï¸ ë¡œë˜ëŠ” ë¬´ì‘ìœ„ ì¶”ì²¨ì…ë‹ˆë‹¤. í†µê³„ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</p></div>
  </div>
</div>

<div class="modal-overlay" id="roundModal">
  <div class="modal"><h3>íšŒì°¨ ì…ë ¥</h3><input type="number" id="roundInput" placeholder="íšŒì°¨" inputmode="numeric">
    <div class="modal-buttons"><button class="btn btn-outline" onclick="closeRoundModal()">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="goToRound()">ì´ë™</button></div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-item active" onclick="showSection('home',this)"><span>ğŸ </span>í™ˆ</button>
  <button class="nav-item" onclick="showSection('stats',this)"><span>ğŸ“Š</span>í†µê³„</button>
  <button class="nav-item" onclick="showSection('predict',this)"><span>ğŸ”®</span>ì˜ˆì¸¡</button>
  <button class="nav-item" onclick="showSection('settings',this)"><span>âš™ï¸</span>ì„¤ì •</button>
</nav>

<script>
let lottoData=[],currentIndex=0,checkNumbers=new Set(),excludedNumbers=new Set(),requiredNumbers=new Set(),predictCount=5,statData=[],currentSort={key:'num',asc:true},currentFilter='all',zFilter='all';

async function init(){
  try{
    const res=await fetch('lotto_data.json');
    if(!res.ok)throw new Error('ë°ì´í„° ì—†ìŒ');
    lottoData=await res.json();
    lottoData.sort((a,b)=>b.round-a.round);
    document.getElementById('loading').style.display='none';
    document.getElementById('sec-home').classList.add('active');
    renderCurrentRound();initNumberGrids();calculateStats();renderStats();updateDataStatus();
  }catch(e){
    document.getElementById('loading').innerHTML='<p style="color:var(--danger)">âŒ '+e.message+'</p><button class="btn btn-primary" style="margin-top:16px" onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>';
  }
}

function getBallClass(n){return n<=10?'b1':n<=20?'b2':n<=30?'b3':n<=40?'b4':'b5'}
function createBall(n,size='',bonus=false){return '<div class="ball '+size+' '+getBallClass(n)+(bonus?' bonus':'')+'">'+n+'</div>'}
function createBalls(nums,bonus=null,size='sm'){let h=nums.map(n=>createBall(n,size)).join('');if(bonus)h+='<span class="plus">+</span>'+createBall(bonus,size,true);return h}
function formatMoney(a){if(!a)return'-';if(a>=1e8)return(a/1e8).toFixed(1)+'ì–µ';if(a>=1e4)return Math.floor(a/1e4).toLocaleString()+'ë§Œ';return a.toLocaleString()}
function formatDate(d){if(!d||d.length!==8)return d||'';return d.slice(0,4)+'.'+d.slice(4,6)+'.'+d.slice(6,8)}
function calcNetPrize(a){if(!a)return 0;return a>3e8?a-(3e8*.22)-((a-3e8)*.33):a*.78}
function showSection(id,el){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));el.classList.add('active');document.getElementById('sec-'+id).classList.add('active');window.scrollTo(0,0)}

function renderCurrentRound(){
  const item=lottoData[currentIndex];if(!item)return;
  document.getElementById('currentRound').textContent=item.round+'íšŒ';
  document.getElementById('currentDate').textContent=formatDate(item.date);
  document.getElementById('currentBalls').innerHTML=createBalls(item.numbers,item.bonus,'');
  const p1=item.rank1?.prize||0,w1=item.rank1?.winners||0,t1=w1>0?p1*w1:(item.rank1?.totalPrize||0),n1=calcNetPrize(p1);
  document.getElementById('prize1').textContent=formatMoney(p1)+'ì›';
  document.getElementById('prize1Net').textContent='ì‹¤ìˆ˜ë ¹ì•¡: ì•½ '+formatMoney(n1)+'ì›';
  document.getElementById('prize1Info').textContent=w1+'ëª… ë‹¹ì²¨ (ì´ '+formatMoney(t1)+'ì›)';
  const p2=item.rank2?.prize||0,w2=item.rank2?.winners||0;
  document.getElementById('prize2').textContent=formatMoney(p2)+'ì›';document.getElementById('prize2Info').textContent=w2+'ëª…';
  const p3=item.rank3?.prize||0,w3=item.rank3?.winners||0;
  document.getElementById('prize3').textContent=formatMoney(p3)+'ì›';document.getElementById('prize3Info').textContent=w3+'ëª…';
  document.getElementById('totalSales').textContent=formatMoney(item.totalSales)+'ì›';
  document.getElementById('totalWinners').textContent=(item.totalWinners||0).toLocaleString()+'ëª…';
  document.getElementById('prevBtn').disabled=currentIndex>=lottoData.length-1;
  document.getElementById('nextBtn').disabled=currentIndex<=0;
}
function prevRound(){if(currentIndex<lottoData.length-1){currentIndex++;renderCurrentRound()}}
function nextRound(){if(currentIndex>0){currentIndex--;renderCurrentRound()}}
function openRoundModal(){document.getElementById('roundModal').classList.add('active');document.getElementById('roundInput').value='';document.getElementById('roundInput').focus()}
function closeRoundModal(){document.getElementById('roundModal').classList.remove('active')}
function goToRound(){const r=parseInt(document.getElementById('roundInput').value),idx=lottoData.findIndex(d=>d.round===r);if(idx!==-1){currentIndex=idx;renderCurrentRound();closeRoundModal()}else alert('í•´ë‹¹ íšŒì°¨ ì—†ìŒ')}
document.getElementById('roundModal').addEventListener('click',function(e){if(e.target===this)closeRoundModal()});
document.getElementById('roundInput').addEventListener('keypress',function(e){if(e.key==='Enter')goToRound()});

function initNumberGrids(){
  ['checkGrid','excludeGrid','requireGrid'].forEach(gid=>{
    const g=document.getElementById(gid);g.innerHTML='';
    for(let i=1;i<=45;i++){const b=document.createElement('button');b.className='number-btn '+getBallClass(i);b.textContent=i;b.onclick=()=>toggleNumber(gid,i,b);g.appendChild(b)}
  });
}
function toggleNumber(gid,num,btn){
  if(gid==='checkGrid'){if(checkNumbers.has(num)){checkNumbers.delete(num);btn.classList.remove('selected')}else if(checkNumbers.size<6){checkNumbers.add(num);btn.classList.add('selected')}updateSelectedBalls()}
  else if(gid==='excludeGrid'){if(excludedNumbers.has(num)){excludedNumbers.delete(num);btn.classList.remove('excluded')}else{excludedNumbers.add(num);requiredNumbers.delete(num);btn.classList.add('excluded');document.querySelectorAll('#requireGrid .number-btn')[num-1].classList.remove('required')}}
  else if(gid==='requireGrid'){if(requiredNumbers.has(num)){requiredNumbers.delete(num);btn.classList.remove('required')}else if(requiredNumbers.size<5&&!excludedNumbers.has(num)){requiredNumbers.add(num);btn.classList.add('required')}}
}
function updateSelectedBalls(){document.getElementById('selectedBalls').innerHTML=[...checkNumbers].sort((a,b)=>a-b).map(n=>createBall(n,'xs')).join('')}
function clearCheck(){checkNumbers.clear();document.querySelectorAll('#checkGrid .number-btn').forEach(b=>b.classList.remove('selected'));updateSelectedBalls();document.getElementById('checkResult').innerHTML=''}

function checkMyNumbers(){
  if(checkNumbers.size!==6){document.getElementById('checkResult').innerHTML='<div class="alert alert-danger">6ê°œ ì„ íƒí•˜ì„¸ìš”</div>';return}
  const item=lottoData[currentIndex],my=[...checkNumbers],win=item.numbers,bonus=item.bonus;
  const matched=my.filter(n=>win.includes(n)),bm=my.includes(bonus);
  let rank='ë‚™ì²¨',prize=0,isWin=false;
  if(matched.length===6){rank='1ë“±';prize=item.rank1?.prize||0;isWin=true}
  else if(matched.length===5&&bm){rank='2ë“±';prize=item.rank2?.prize||0;isWin=true}
  else if(matched.length===5){rank='3ë“±';prize=item.rank3?.prize||0;isWin=true}
  else if(matched.length===4){rank='4ë“±';prize=item.rank4?.prize||0;isWin=true}
  else if(matched.length===3){rank='5ë“±';prize=item.rank5?.prize||0;isWin=true}
  document.getElementById('checkResult').innerHTML='<div class="check-result"><div class="check-rank '+(isWin?'win':'lose')+'">'+rank+'</div>'+(prize>0?'<div class="check-prize">'+formatMoney(prize)+'ì›</div><div style="color:var(--success);font-size:13px">ì‹¤ìˆ˜ë ¹: '+formatMoney(calcNetPrize(prize))+'ì›</div>':'')+'<div style="color:var(--text2);font-size:13px">'+matched.length+'ê°œ ì¼ì¹˜'+(bm?' + ë³´ë„ˆìŠ¤':'')+'</div></div>';
}

function calculateStats(){
  statData=[];const freq={},lastSeen={},gaps={};
  for(let i=1;i<=45;i++){freq[i]=0;lastSeen[i]=-1;gaps[i]=[]}
  lottoData.forEach((item,idx)=>{item.numbers.forEach(n=>{freq[n]++;if(lastSeen[n]!==-1)gaps[n].push(idx-lastSeen[n]);lastSeen[n]=idx})});
  const total=lottoData.length,mean=Object.values(freq).reduce((a,b)=>a+b,0)/45,std=Math.sqrt(Object.values(freq).reduce((s,v)=>s+Math.pow(v-mean,2),0)/45);
  for(let i=1;i<=45;i++){
    const avgGap=gaps[i].length>0?gaps[i].reduce((a,b)=>a+b,0)/gaps[i].length:total;
    const lastIdx=lottoData.findIndex(d=>d.numbers.includes(i));
    statData.push({num:i,count:freq[i],percent:(freq[i]/(total*6)*100).toFixed(2),last:lastIdx===-1?total:lastIdx,avgGap:avgGap.toFixed(1),zscore:((freq[i]-mean)/std).toFixed(2)});
  }
  window.statSummary={mean,std,min:Math.min(...Object.values(freq)),max:Math.max(...Object.values(freq))};
}

function showStatTab(id,el){document.querySelectorAll('#sec-stats .tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.stat-content').forEach(c=>c.style.display='none');el.classList.add('active');document.getElementById('stat-'+id).style.display='block'}

function renderStats(){renderFreqTable();renderPatternStats();renderZTable()}
function renderFreqTable(){
  let data=[...statData];
  if(currentFilter==='1-10')data=data.filter(d=>d.num<=10);
  else if(currentFilter==='11-20')data=data.filter(d=>d.num>10&&d.num<=20);
  else if(currentFilter==='21-30')data=data.filter(d=>d.num>20&&d.num<=30);
  else if(currentFilter==='31-40')data=data.filter(d=>d.num>30&&d.num<=40);
  else if(currentFilter==='41-45')data=data.filter(d=>d.num>40);
  else if(currentFilter==='hot')data=data.filter(d=>parseFloat(d.zscore)>1);
  else if(currentFilter==='cold')data=data.filter(d=>parseFloat(d.zscore)<-1);
  data.sort((a,b)=>{let va=a[currentSort.key],vb=b[currentSort.key];if(typeof va==='string'){va=parseFloat(va);vb=parseFloat(vb)}return currentSort.asc?va-vb:vb-va});
  document.getElementById('freqTableBody').innerHTML=data.map(d=>'<tr><td>'+createBall(d.num,'xs')+'</td><td>'+d.count+'íšŒ</td><td>'+d.percent+'%</td><td>'+(d.last===0?'ìµœê·¼':d.last+'íšŒì „')+'</td><td>'+d.avgGap+'íšŒ</td></tr>').join('');
}
function sortTable(key){if(currentSort.key===key)currentSort.asc=!currentSort.asc;else{currentSort.key=key;currentSort.asc=true}renderFreqTable()}
function filterTable(f,el){currentFilter=f;document.querySelectorAll('#stat-freq .filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderFreqTable()}

function renderPatternStats(){
  const oe=[0,0,0,0,0,0,0],hl=[0,0,0,0,0,0,0];let sums=[],consec=0,acSum=0;
  lottoData.forEach(item=>{
    const nums=item.numbers,odd=nums.filter(n=>n%2===1).length,low=nums.filter(n=>n<=22).length;
    oe[odd]++;hl[low]++;sums.push(nums.reduce((a,b)=>a+b,0));
    const sorted=[...nums].sort((a,b)=>a-b);for(let i=0;i<sorted.length-1;i++)if(sorted[i+1]-sorted[i]===1)consec++;
    const diffs=new Set();for(let i=0;i<nums.length;i++)for(let j=i+1;j<nums.length;j++)diffs.add(Math.abs(nums[j]-nums[i]));acSum+=diffs.size-5;
  });
  const total=lottoData.length;
  document.getElementById('oddEvenBody').innerHTML=oe.map((v,i)=>'<tr><td>'+i+':'+(6-i)+'</td><td>'+v+'íšŒ</td><td>'+(v/total*100).toFixed(1)+'%</td></tr>').join('');
  document.getElementById('highLowBody').innerHTML=hl.map((v,i)=>'<tr><td>'+i+':'+(6-i)+'</td><td>'+v+'íšŒ</td><td>'+(v/total*100).toFixed(1)+'%</td></tr>').join('');
  const avgSum=(sums.reduce((a,b)=>a+b,0)/total).toFixed(1),minSum=Math.min(...sums),maxSum=Math.max(...sums),avgAC=(acSum/total).toFixed(2);
  document.getElementById('extraStats').innerHTML='<p>ğŸ“Š ì´í•© í‰ê· : <strong>'+avgSum+'</strong> ('+minSum+'~'+maxSum+')</p><p>ğŸ”— ì—°ì†ë²ˆí˜¸: ì´ '+consec+'ìŒ (í‰ê·  '+(consec/total).toFixed(2)+'ìŒ/íšŒì°¨)</p><p>ğŸ² ACê°’ í‰ê· : <strong>'+avgAC+'</strong></p>';
}

function renderZTable(){
  let data=[...statData];
  if(zFilter==='hot')data=data.filter(d=>parseFloat(d.zscore)>1.5);
  else if(zFilter==='cold')data=data.filter(d=>parseFloat(d.zscore)<-1.5);
  data.sort((a,b)=>parseFloat(b.zscore)-parseFloat(a.zscore));
  document.getElementById('zscoreBody').innerHTML=data.map(d=>{
    const z=parseFloat(d.zscore);let st='ë³´í†µ',sc='var(--text2)';if(z>1.5){st='ğŸ”¥HOT';sc='var(--danger)'}else if(z<-1.5){st='â„ï¸COLD';sc='#4dabf7'}
    return '<tr><td>'+createBall(d.num,'xs')+'</td><td>'+d.count+'íšŒ</td><td style="color:'+(z>0?'var(--danger)':'#4dabf7')+'">'+d.zscore+'</td><td style="color:'+sc+'">'+st+'</td></tr>';
  }).join('');
}
function filterZ(f,el){zFilter=f;document.querySelectorAll('#stat-zscore .filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderZTable()}
function sortZ(key){statData.sort((a,b)=>key==='zscore'?parseFloat(b.zscore)-parseFloat(a.zscore):key==='count'?b.count-a.count:a.num-b.num);renderZTable()}

function adjustCount(d){predictCount=Math.max(1,Math.min(10,predictCount+d));document.getElementById('predictCount').textContent=predictCount}
function generatePrediction(){
  const strategy=document.getElementById('predictStrategy').value,results=[];
  const freq={},lastSeen={};for(let i=1;i<=45;i++){freq[i]=0;lastSeen[i]=9999}
  lottoData.forEach((item,idx)=>{item.numbers.forEach(n=>{freq[n]++;if(idx<lastSeen[n])lastSeen[n]=idx})});
  const available=[];for(let i=1;i<=45;i++)if(!excludedNumbers.has(i))available.push(i);
  for(let set=0;set<predictCount;set++){
    const selected=[...requiredNumbers],pool=available.filter(n=>!requiredNumbers.has(n));
    while(selected.length<6&&pool.length>0){
      let idx;
      switch(strategy){
        case'hot':pool.sort((a,b)=>freq[b]-freq[a]);idx=Math.floor(Math.random()*Math.min(15,pool.length));break;
        case'cold':pool.sort((a,b)=>freq[a]-freq[b]);idx=Math.floor(Math.random()*Math.min(15,pool.length));break;
        case'balanced':pool.sort((a,b)=>(freq[b]+lastSeen[b]*2)-(freq[a]+lastSeen[a]*2));idx=Math.floor(Math.random()*Math.min(20,pool.length));break;
        case'pattern':const odds=selected.filter(n=>n%2===1).length,needOdd=odds<3,filtered=pool.filter(n=>needOdd?n%2===1:n%2===0);if(filtered.length>0){idx=Math.floor(Math.random()*filtered.length);selected.push(filtered[idx]);pool.splice(pool.indexOf(filtered[idx]),1);continue}idx=Math.floor(Math.random()*pool.length);break;
        case'zscore':const mean=Object.values(freq).reduce((a,b)=>a+b,0)/45;pool.sort((a,b)=>Math.abs(freq[b]-mean)-Math.abs(freq[a]-mean));idx=Math.floor(Math.random()*Math.min(15,pool.length));break;
        case'trend':const rf={};for(let i=1;i<=45;i++)rf[i]=0;lottoData.slice(0,10).forEach(item=>item.numbers.forEach(n=>rf[n]++));pool.sort((a,b)=>rf[b]-rf[a]);idx=Math.floor(Math.random()*Math.min(15,pool.length));break;
        default:idx=Math.floor(Math.random()*pool.length);
      }
      selected.push(pool[idx]);pool.splice(idx,1);
    }
    results.push(selected.sort((a,b)=>a-b));
  }
  document.getElementById('predictResults').innerHTML=results.map((nums,i)=>'<div class="predict-result"><div class="predict-index">'+(i+1)+'ë²ˆ</div><div class="balls">'+createBalls(nums,null,'sm')+'</div></div>').join('');
}

function updateDataStatus(){
  if(!lottoData.length){document.getElementById('dataStatus').innerHTML='<p>ë°ì´í„° ì—†ìŒ</p>';return}
  const first=lottoData[lottoData.length-1],last=lottoData[0];
  document.getElementById('dataStatus').innerHTML='<table class="stat-table"><tr><td>ì´ íšŒì°¨</td><td><strong>'+lottoData.length+'íšŒ</strong></td></tr><tr><td>ë²”ìœ„</td><td>'+first.round+'íšŒ ~ '+last.round+'íšŒ</td></tr><tr><td>ìµœì‹ </td><td>'+formatDate(last.date)+'</td></tr></table>';
}
function exportData(){const b=new Blob([JSON.stringify(lottoData,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='lotto_data.json';a.click()}

init();
</script>
</body>
</html>
